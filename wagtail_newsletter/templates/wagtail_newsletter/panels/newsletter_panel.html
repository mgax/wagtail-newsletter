{% load wagtailadmin_tags %}

{% if self.instance.pk %}
    <div
        class="wn-panel loading-mask"
        data-controller="wn-panel"
        data-wn-panel-loaded-value="{{ self.loaded|lower }}"
        data-wn-panel-urls-value="{{ urls_json }}"
        data-wn-panel-user-email-value="{{ user_email }}"
        {% if recipients %}
            data-wn-panel-recipients-description-value=
                "&quot;{{ recipients.name }}&quot; with {{ recipients.member_count }} subscribers"
        {% endif %}
        data-wn-panel-error-class="wn-panel--error"
        data-wn-panel-loading-class="loading"
        data-wn-panel-unsaved-class="wn-panel--unsaved"
        data-action="w-unsaved:add@document->wn-panel#unsaved"
    >
        {% if loaded and not campaign_sent %}
            <div class="help-block help-info">
                {% icon name="help" %}
                These actions will save the latest revision of the page as a
                campaign in {{ self.heading }}. Please be sure to save the page
                first.
            </div>

            <div class="help-block help-warning wn-panel__unsaved-warning">
                {% icon name="warning" %}
                You have unsaved changes. The newsletter will reflect the most
                recently saved version.
            </div>

            <div class="help-block help-critical wn-panel__error-block">
                {% icon name="warning" %}
                <output data-wn-panel-target="errorMessage"></output>
            </div>

            <p>
                <button
                    type="button"
                    class="button button-small button-secondary button-longrunning"
                    data-controller="w-progress"
                    data-action="wn-panel#saveDraft"
                    data-wn-panel-target="saveDraft button"
                >
                    {% icon name="spinner" %}
                    Save campaign draft
                </button>

                <button
                    type="button"
                    class="button button-small button-secondary"
                    data-action="wn-panel#sendTestEmail"
                    data-wn-panel-target="sendTestEmail button"
                >
                    Send test email
                </button>

                <button
                    type="button"
                    class="button button-small"
                    data-action="wn-panel#sendCampaign"
                    data-wn-panel-target="sendCampaign button"
                    {% if not recipients %}
                        disabled
                    {% endif %}
                >
                    Send campaign
                </button>
            </p>
        {% endif %}

        <p class="help" data-wn-panel-target="message">
            {{ message }}
        </p>

        {% if campaign %}
            <p>
                <a href="{{ campaign.url }}" target="_blank">
                    {% icon name="link-external" classname="w-w-4 w-h-4" %}
                    Open campaign in {{ self.heading }}
                </a>
            </p>
        {% endif %}

        {% if campaign_sent %}
            {% block campaign_status %}
                <p>
                    <b>Status:</b>
                    {{ campaign.status }}
                </p>

                {% with report=campaign.get_report %}
                    {% if report.send_time %}
                        <p>
                            <b>Send time:</b>
                            {{ report.send_time }}
                            ({{ report.send_time|timesince }} ago).
                        </p>
                    {% endif %}

                    <p>
                        <b>Emails sent:</b>
                        {{ report.emails_sent }} ({{ report.bounces }} bounces)
                    </p>

                    <p>
                        <b>Opens:</b>
                        {{ report.opens }}
                    </p>

                    <p>
                        <b>Clicks:</b>
                        {{ report.clicks }}
                    </p>
                {% endwith %}
            {% endblock %}
        {% endif %}
    </div>
{% else %}
    <div class="help-block help-info">
        {% icon name="help" %}
        Page must be saved before it can be sent as a newsletter.
    </div>

{% endif %}
